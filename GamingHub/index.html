<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GamerHub Pro | Multiplayer & Offline</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="carrom-engine.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #a855f7;
            --bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text: #f8fafc;
            --board-size: 480px;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            height: 100vh;
        }

        /* --- UI Hub Layer --- */
        #hub {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            padding: 20px;
            transition: transform 0.5s ease-in-out;
        }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            max-width: 900px;
            width: 100%;
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .game-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .game-btn:hover {
            background: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.4);
        }

        .game-icon {
            font-size: 2.5rem;
            margin-bottom: 5px;
        }

        .game-meta {
            font-size: 0.7rem;
            opacity: 0.5;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        .gaming-header {
            margin-bottom: 40px;
        }

        .hub-badge {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
            padding: 6px 16px;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 800;
            letter-spacing: 2px;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .community-section {
            margin-top: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .status-indicator .dot {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            box-shadow: 0 0 10px #22c55e;
            animation: blink 2s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        /* --- Multiplayer Toggle --- */
        .toggle-container {
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px 20px;
            border-radius: 50px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #475569;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary);
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }

        /* --- Game Viewport --- */
        #game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            background: #000;
            z-index: 100;
        }

        #game-canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            z-index: 110;
            font-weight: bold;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        /* --- Mobile Controls --- */
        #mobile-controls {
            position: absolute;
            bottom: 40px;
            left: 0;
            width: 100%;
            display: none;
            justify-content: space-around;
            padding: 0 20px;
            z-index: 150;
        }

        .control-btn {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            user-select: none;
            touch-action: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .control-btn:active {
            background: var(--primary);
            transform: scale(0.9);
        }

        /* --- Multiplayer HUD --- */
        #multiplayer-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 255, 0, 0.2);
            padding: 5px 15px;
            border-radius: 50px;
            font-size: 0.8rem;
            display: none;
        }

        /* --- Pro Chess UI --- */
        .chess-container {
            display: grid;
            place-items: center;
            /* Use grid for more robust centering */
            gap: 12px;
            padding: 10px;
            height: 100vh;
            width: 100vw;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            overflow: hidden;
            position: fixed;
            /* Fixed to avoid page scroll interference */
            top: 0;
            left: 0;
        }

        #myBoard {
            width: var(--board-size);
            height: var(--board-size);
            max-width: 95vw;
            max-height: 95vw;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.7), inset 0 0 15px rgba(0, 0, 0, 0.5);
            border: 8px solid #3d2b1f;
            /* Thinner border for scaling */
            border-radius: 4px;
            background: #2D1B10;
            touch-action: none;
        }

        .chess-info {
            display: flex;
            width: var(--board-size);
            max-width: 95vw;
            justify-content: space-between;
            align-items: center;
            background: rgba(15, 23, 42, 0.6);
            padding: 8px 15px;
            /* Compact padding */
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: bold;
            color: #e2e8f0;
        }

        .timer {
            font-family: 'Inter', sans-serif;
            font-size: 1.25rem;
            /* Smaller timer */
            color: #fbbf24;
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 50px;
            background: var(--primary);
            font-size: 0.9rem;
        }

        /* --- Chess Wood Theme & Side Controls --- */
        .chess-wood-theme {
            background-color: #3e2723;
            background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://www.transparenttextures.com/patterns/wood-pattern.png');
            background-size: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
        }

        .side-controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 200;
        }

        .round-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.8);
            border: 3px solid #facc15;
            color: #facc15;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            padding: 0;
        }

        .round-btn:hover {
            background: #facc15;
            color: #451a03;
            transform: scale(1.1);
        }

        .round-btn:active {
            transform: scale(0.95);
        }

        /* Override chessboard colors for wood look */
        .chess-wood-theme #myBoard {
            border: 12px solid #5d4037 !important;
            border-radius: 8px !important;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8) !important;
        }

        .chess-wood-theme .white-1e1d7 {
            background-color: #dcb084 !important;
            /* Light wood */
        }

        .chess-wood-theme .black-1e1d7 {
            background-color: #5d4037 !important;
            /* Dark wood */
        }

        /* --- High-Fidelity 3D Wooden Pieces --- */
        .chess-wood-theme img[src*="chesspieces"] {
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: auto;
        }

        /* White Pieces: Yellowish Oak Wood */
        .chess-wood-theme img[src*="/w"] {
            filter: sepia(0.8) saturate(2.2) brightness(1.1) contrast(1.1) drop-shadow(1px 1px 0px rgba(255, 255, 255, 0.4)) drop-shadow(2px 4px 6px rgba(0, 0, 0, 0.6));
        }

        /* Black Pieces: Dark Walnut Wood */
        .chess-wood-theme img[src*="/b"] {
            filter: sepia(0.5) saturate(1.2) brightness(0.5) contrast(1.4) drop-shadow(1px 1px 0px rgba(255, 255, 255, 0.1)) drop-shadow(2px 5px 8px rgba(0, 0, 0, 0.8));
        }

        /* Hover Effect (Slight lift) */
        .chess-wood-theme img[src*="chesspieces"]:hover {
            transform: translateY(-5px) scale(1.08);
            filter: brightness(1.2) drop-shadow(5px 10px 15px rgba(0, 0, 0, 0.5));
        }

        /* Active/Press Effect */
        .chess-wood-theme img[src*="chesspieces"]:active {
            transform: translateY(2px) scale(0.95);
            filter: brightness(0.9);
        }

        /* Adjust side controls for larger board */
        .chess-wood-theme .side-controls {
            left: 20px;
            gap: 15px;
        }

        .chess-wood-theme .round-btn {
            width: 50px;
            height: 50px;
            font-size: 1.25rem;
        }

        .game-status-overlay {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 40px;
            border-radius: 24px;
            z-index: 400;
            text-align: center;
            display: none;
            box-shadow: 0 0 100px rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .captured-pieces {
            display: flex;
            gap: 2px;
            font-size: 1.1rem;
            /* Smaller pieces */
            min-height: 1.4rem;
            color: #aaa;
            margin-top: 2px;
        }

        .move-history {
            width: 220px;
            height: calc(var(--board-size) + 100px);
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            padding: 15px;
            overflow-y: auto;
            font-size: 0.95rem;
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* --- Chess Settings Modal --- */
        .settings-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 500;
            animation: fadeIn 0.3s ease;
        }

        .settings-modal {
            background: rgba(30, 41, 59, 0.95);
            border: 2px solid #facc15;
            border-radius: 20px;
            padding: 30px;
            width: 350px;
            color: white;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .settings-row label {
            font-size: 0.95rem;
            opacity: 0.9;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .move-row {
            display: grid;
            grid-template-columns: 35px 1fr 1fr;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #f8fafc;
        }

        /* Chess Highlights */
        .highlight-white {
            box-shadow: inset 0 0 3px 3px rgba(255, 255, 255, 0.5);
            transition: box-shadow 0.2s ease;
        }

        .highlight-black {
            box-shadow: inset 0 0 3px 3px rgba(0, 0, 0, 0.5);
            transition: box-shadow 0.2s ease;
        }

        .highlight-hint {
            background: radial-gradient(rgba(0, 0, 0, 0.1) 19%, rgba(0, 0, 0, 0) 20%);
            transition: background 0.3s ease;
        }

        .highlight-hint-capture {
            box-shadow: inset 0 0 0 6px rgba(0, 0, 0, 0.1);
        }

        /* Override chessboard colors for premium look */
        .white-1e1d7 {
            background-color: #f0d9b5 !important;
            background-image: linear-gradient(rgba(255, 255, 255, 0.05), rgba(0, 0, 0, 0.05));
        }

        .black-1e1d7 {
            background-color: #b58863 !important;
            background-image: linear-gradient(rgba(255, 255, 255, 0.05), rgba(0, 0, 0, 0.1));
        }

        #myBoard div[class*="square-"] {
            cursor: pointer !important;
        }

        .matchmaking-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: var(--primary);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* --- Premium Carrom Styles --- */
        .carrom-avatar {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            border: 3px solid #fbbf24;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.4);
            object-fit: cover;
        }

        .level-badge {
            position: absolute;
            top: -10px;
            left: -10px;
            background: linear-gradient(135deg, #fbbf24, #d97706);
            color: #451a03;
            font-weight: bold;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 6px;
            border: 1px solid #78350f;
        }

        .score-display {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0, 0, 0, 0.4);
            padding: 10px 20px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .coin-stack {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .coin-icon {
            width: 40px;
            height: 40px;
            background: radial-gradient(circle at 30% 30%, #fde68a, #fbbf24);
            border-radius: 50%;
            border: 2px solid #78350f;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        #striker-control-bar {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 45px;
            background: linear-gradient(to bottom, #78350f, #451a03);
            border-radius: 25px;
            border: 3px solid #fbbf24;
            display: flex;
            align-items: center;
            padding: 0 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            cursor: pointer;
        }

        #striker-handle {
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, #fff, #94a3b8);
            border-radius: 50%;
            border: 2px solid #475569;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            transition: left 0.05s linear;
        }

        .score-display.p1-active {
            border-color: #fbbf24;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
            background: rgba(251, 191, 36, 0.15);
        }

        .score-display.p2-active {
            border-color: #3b82f6;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
            background: rgba(59, 130, 246, 0.15);
        }

        .thinking-msg {
            font-size: 0.8rem;
            color: #94a3b8;
            font-style: italic;
            margin-top: 5px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }
        }

        /* --- Premium Carrom UI Overlay --- */
        #carrom-ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            /* Let clicks pass through to canvas generally */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
            z-index: 200;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
        }

        /* Profile Cards */
        .profile-card {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            padding: 10px 25px 10px 10px;
            border-radius: 50px;
            /* Pill shape */
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            min-width: 220px;
            transform: scale(0.9);
            transform-origin: top;
        }

        .p1-card {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(217, 119, 6, 0.2));
            border-color: rgba(251, 191, 36, 0.4);
        }

        .p2-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(30, 58, 138, 0.4));
            border-color: rgba(59, 130, 246, 0.4);
            flex-direction: row-reverse;
            /* AI on right, reversed layout */
            padding: 10px 10px 10px 25px;
        }

        .avatar-frame {
            width: 65px;
            height: 65px;
            border-radius: 18px;
            overflow: hidden;
            border: 3px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            background: #000;
        }

        .avatar-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .info {
            display: flex;
            flex-direction: column;
            color: white;
            justify-content: center;
        }

        .p2-card .info {
            align-items: flex-end;
            /* Right align AI text */
        }

        .name {
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.9;
        }

        .p1-card .name {
            color: #fbbf24;
        }

        .p2-card .name {
            color: #60a5fa;
        }

        .score-box {
            font-size: 1.4rem;
            font-weight: 900;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .level-badge-ui {
            position: absolute;
            top: -5px;
            left: -5px;
            background: #fbbf24;
            color: #451a03;
            font-weight: bold;
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
        }

        .p2-card .level-badge-ui {
            left: auto;
            right: -5px;
            background: #3b82f6;
            color: white;
        }

        /* Turn Indicator */
        .turn-pill {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            padding: 10px 40px;
            border-radius: 30px;
            color: white;
            font-weight: 800;
            letter-spacing: 2px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            text-transform: uppercase;
            transform: translateY(10px);
            display: none;
            /* JS will toggle */
        }

        .turn-pill.active {
            display: block;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from {
                transform: translateY(-20px) scale(0.8);
                opacity: 0;
            }

            to {
                transform: translateY(10px) scale(1);
                opacity: 1;
            }
        }

        /* Bottom Control Bar */
        #bottom-bar {
            width: 100%;
            display: flex;
            justify-content: center;
            padding-bottom: 20px;
            pointer-events: auto;
            /* Allow interaction */
        }

        .slider-wood-container {
            width: 90%;
            max-width: 500px;
            height: 60px;
            background: linear-gradient(to bottom, #5d4037, #3e2723);
            border-radius: 30px;
            border: 4px solid #8d6e63;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6), inset 0 2px 5px rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            padding: 0 20px;
            position: relative;
        }

        .slider-track {
            width: 100%;
            height: 12px;
            background: #281815;
            border-radius: 10px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.8);
            position: relative;
        }

        .slider-knob {
            width: 44px;
            height: 44px;
            background: radial-gradient(circle at 30% 30%, #22d3ee, #0891b2);
            border: 3px solid #164e63;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            /* Start center */
            cursor: grab;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        .slider-knob:active {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(0.95);
        }

        .slider-knob::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 12px;
            height: 12px;
            background: rgba(255, 255, 255, 0.4);
            transform: translate(-50%, -50%);
            border-radius: 50%;
        }

        /* Force hide carrom premium UI */
        #carrom-ui-layer {
            display: none !important;
            visibility: hidden !important;
        }

        /* --- Mobile Responsive Fixes --- */
        @media (max-width: 768px) {
            .chess-wood-theme {
                flex-direction: column !important;
                justify-content: flex-start !important;
                padding-top: 20px !important;
                gap: 10px !important;
            }

            /* Move controls to bottom row */
            .side-controls {
                position: fixed !important;
                bottom: 20px !important;
                left: 50% !important;
                top: auto !important;
                transform: translateX(-50%) !important;
                flex-direction: row !important;
                width: max-content !important;
                background: rgba(62, 39, 35, 0.9);
                padding: 10px 20px;
                border-radius: 30px;
                border: 2px solid #facc15;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
                gap: 20px !important;
            }

            .round-btn {
                width: 45px !important;
                height: 45px !important;
                font-size: 1.2rem !important;
            }

            /* Hide history panel on mobile */
            .move-history-panel {
                display: none !important;
            }

            /* Adjust board container */
            .chess-main-view {
                transform: scale(0.95);
                margin-top: 10px;
            }
        }
    </style>

</head>

<body>
    <!-- UI Hub -->
    <div id="hub">
        <div class="glass-card">
            <div class="gaming-header">
                <span class="hub-badge" style="margin-bottom: 20px;">REELIO GAMING</span>
            </div>

            <div class="game-grid">
                <div class="game-btn" onclick="startGame('chess')">
                    <div class="game-icon">‚ôî</div>
                    <b>Chess Pro</b>
                    <span class="game-meta">AI & Multiplayer</span>
                </div>
                <div class="game-btn" onclick="startGame('car-racing')">
                    <div class="game-icon">üèé</div>
                    <b>Nitro Racing</b>
                    <span class="game-meta">Police Chase Mode</span>
                </div>
                <div class="game-btn" onclick="startGame('carrom')">
                    <div class="game-icon">üî¥</div>
                    <b>Carrom Gold</b>
                    <span class="game-meta">Physics Based</span>
                </div>
            </div>

            <div class="community-section">
                <div class="toggle-container">
                    <span>Practice Mode</span>
                    <label class="switch">
                        <input type="checkbox" id="mp-toggle" onchange="toggleMultiplayer()">
                        <span class="slider"></span>
                    </label>
                    <span>Multiplayer</span>
                </div>
                <div id="conn-status" class="status-indicator">
                    <span class="dot"></span>
                    <span class="status-text">Connecting to Reelio Servers...</span>
                </div>
            </div>
        </div>
    </div>
    <!-- Game Viewport -->
    <div id="game-container">
        <!-- Overlay for detailed status messages if needed -->
        <div id="game-status-msg" class="game-status-overlay">
            <h2 id="status-title"></h2>
            <p id="status-desc"></p><button id="restart-btn" class="game-btn"
                onclick="restartGame()">Restart</button><button class="game-btn" onclick="backToHub()">Back
                to Hub</button>
        </div><button class="back-btn" onclick="backToHub()">Exit Game</button>
        <div id="multiplayer-status">MP ACTIVE</div><canvas id="game-canvas"></canvas>
        <div id="mobile-controls">
            <div class="control-btn" id="btn-left">‚Üê</div>
            <div class="control-btn" id="btn-right">‚Üí</div>
        </div>
        <div id="html-overlay"
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50;">
        </div>

        <!-- Matchmaking Overlay -->
        <div id="matchmaking-overlay" class="matchmaking-overlay">
            <div class="loader"></div>
            <h2 style="color: white; margin-bottom: 5px;">Searching for Opponent...</h2>
            <p style="color: rgba(255,255,255,0.6);">Joining matchmaking queue</p>
        </div>

    </div>
    <script src="racing/track.js"></script>
    <script src="racing/audio.js"></script>
    <script src="racing/input.js"></script>
    <script src="racing/effects.js"></script>
    <script src="racing/utils.js"></script>
    <script src="racing/constants.js"></script>
    <script src="racing/entities.js"></script>
    <script src="racing/game.js"></script>

    <!-- Carrom Engine (Dedicated) -->
    <script src="carrom-engine.js?v=17"></script>
    <script>
        window.onerror = function (msg, url, line) {
            // Ignore generic "Script error." which is a cross-origin security feature and usually harmless
            if (msg === "Script error.") {
                console.warn('Cross-origin script error suppressed from UI.');
                return;
            }

            const existing = document.querySelector('.error-banner');
            if (existing) return; // Only show one active error at a time

            const overlay = document.getElementById('html-overlay') || document.body;
            const err = document.createElement('div');
            err.style.position = 'fixed';
            err.style.bottom = '10px'; // Move to bottom to be less intrusive
            err.style.right = '10px';
            err.style.backgroundColor = 'rgba(239, 68, 68, 0.9)'; // Slightly transparent
            err.style.color = 'white';
            err.style.padding = '8px 16px';
            err.style.borderRadius = '8px';
            err.style.fontSize = '12px';
            err.style.zIndex = '9999';
            err.className = 'error-banner';
            err.innerHTML = `<b>Debug Note:</b> ${msg} (Line ${line}) <span onclick="this.parentElement.remove()" style="cursor:pointer;margin-left:10px;opacity:0.6;">‚úï</span>`;
            document.body.appendChild(err);
            console.error('Global Error:', msg, url, line);
        }
    </script>
    <script>let socket;
        let isMultiplayer = false;
        let currentGame = null;
        let canvas = document.getElementById('game-canvas');
        let ctx = canvas.getContext('2d');
        let overlay = document.getElementById('html-overlay');
        let animationId;

        // --- Multiplayer Logic ---
        function toggleMultiplayer() {
            isMultiplayer = document.getElementById('mp-toggle').checked;
            const status = document.getElementById('conn-status');

            if (isMultiplayer) {
                if (!socket) {

                    // Try to connect to localhost:3000
                    try {
                        const socketUrl = window.location.origin;
                        socket = io(socketUrl, { reconnectionAttempts: 5, timeout: 5000 });

                        socket.on('connect', () => {
                            status.innerText = "Connected to Server (Latency: Low)";
                            status.style.color = "#4ade80";
                            setupMultiplayerSocket();
                        });

                        socket.on('connect_error', () => {
                            status.innerText = "Server Offline - Falling back to Single Player";
                            status.style.color = "#fbbf24";
                            document.getElementById('mp-toggle').checked = false;
                            isMultiplayer = false;
                        });

                        socket.on('disconnect', () => {
                            status.innerText = "Disconnected from Server";
                            status.style.color = "#ef4444";
                        });
                    }

                    catch (e) {
                        status.innerText = "Connection Failed";
                    }
                }

                else if (!socket.connected) {
                    socket.connect();
                }
            }

            else {
                status.innerText = "Offline Mode Active";
                status.style.color = "inherit";
            }
        }


        function backToHub() {
            if (animationId) cancelAnimationFrame(animationId);

            // Stop external modules
            if (typeof stopCarrom === 'function') stopCarrom();
            if (typeof carromEngine !== 'undefined') carromEngine.stop();
            if (typeof RacingGame !== 'undefined' && RacingGame.instance) RacingGame.instance.stop();

            // UI Switching
            document.getElementById('game-container').style.display = "none";
            document.getElementById('hub').style.display = "flex";
            document.getElementById('mobile-controls').style.display = 'none';

            // Fix: Ensure hub is visible immediately
            const hub = document.getElementById('hub');
            hub.style.transform = "scale(1)";
            hub.style.opacity = "1";
            hub.style.display = "flex";

            // Remove Carrom UI
            const carromUi = document.getElementById('carrom-ui-layer');
            if (carromUi) carromUi.remove();

            // Show generic back-btn if hidden
            document.querySelector('.back-btn').style.display = 'block';

            // Clean up overlays
            const overlay = document.getElementById('html-overlay');
            if (overlay) overlay.innerHTML = "";
            document.querySelectorAll('.error-banner').forEach(el => el.remove());

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Reset window events
            window.onkeydown = null;
            window.onkeyup = null;
        }

        // Improved Start Game Function
        function startGame(type) {
            currentGame = type;
            document.getElementById('hub').style.opacity = "0";
            document.getElementById('hub').style.transform = "scale(0.9)";

            setTimeout(() => {
                document.getElementById('hub').style.display = "none";
                document.getElementById('game-container').style.display = "block";

                // Reset Canvas
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (type === 'chess') {
                    startChess();
                } else if (type === 'carrom') {
                    startCarrom();
                } else if (type === 'car-racing' || type === 'police-chase') {
                    startRacing(type);
                    // Ensure Racing UI container fits screen
                    const gameContainer = document.getElementById('game-container');
                    gameContainer.style.overflow = 'hidden';

                    // Wire up mobile controls for touch steering and pedals
                    setTimeout(() => {
                        const btnLeft = document.getElementById('btn-left');
                        const btnRight = document.getElementById('btn-right');
                        const pedalGas = document.getElementById('pedal-gas');
                        const pedalBrake = document.getElementById('pedal-brake');

                        if (window.RacingGame.instance) {
                            const input = window.RacingGame.instance.input;

                            // Steering - Left
                            if (btnLeft) {
                                ['touchstart', 'mousedown'].forEach(evt => {
                                    btnLeft.addEventListener(evt, (e) => {
                                        e.preventDefault();
                                        input.setTouchControl('left', true);
                                    });
                                });
                                ['touchend', 'mouseup', 'mouseleave'].forEach(evt => {
                                    btnLeft.addEventListener(evt, (e) => {
                                        e.preventDefault();
                                        input.setTouchControl('left', false);
                                    });
                                });
                            }

                            // Steering - Right
                            if (btnRight) {
                                ['touchstart', 'mousedown'].forEach(evt => {
                                    btnRight.addEventListener(evt, (e) => {
                                        e.preventDefault();
                                        input.setTouchControl('right', true);
                                    });
                                });
                                ['touchend', 'mouseup', 'mouseleave'].forEach(evt => {
                                    btnRight.addEventListener(evt, (e) => {
                                        e.preventDefault();
                                        input.setTouchControl('right', false);
                                    });
                                });
                            }

                            // Gas Pedal
                            if (pedalGas) {
                                ['touchstart', 'mousedown'].forEach(evt => {
                                    pedalGas.addEventListener(evt, (e) => {
                                        e.preventDefault();
                                        input.setTouchControl('throttle', true);
                                    });
                                });
                                ['touchend', 'mouseup', 'mouseleave'].forEach(evt => {
                                    pedalGas.addEventListener(evt, (e) => {
                                        e.preventDefault();
                                        input.setTouchControl('throttle', false);
                                    });
                                });
                            }

                            // Brake Pedal
                            if (pedalBrake) {
                                ['touchstart', 'mousedown'].forEach(evt => {
                                    pedalBrake.addEventListener(evt, (e) => {
                                        e.preventDefault();
                                        input.setTouchControl('brake', true);
                                    });
                                });
                                ['touchend', 'mouseup', 'mouseleave'].forEach(evt => {
                                    pedalBrake.addEventListener(evt, (e) => {
                                        e.preventDefault();
                                        input.setTouchControl('brake', false);
                                    });
                                });
                            }
                        }
                    }, 500);
                }

                // Join Multiplayer Room if active
                if (isMultiplayer && socket) {
                    document.getElementById('matchmaking-overlay').style.display = 'flex';
                    socket.emit('join-room', { gameType: type });
                }
            }, 300);
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            // Dynamic Chess board sizing
            if (currentGame === 'chess') {
                const availableHeight = window.innerHeight - 150; // Balanced margin for large board AND full boxes
                const size = Math.min(availableHeight, 800, window.innerWidth * 0.85);
                document.documentElement.style.setProperty('--board-size', (size > 250 ? size : 250) + 'px');
                if (board) board.resize();
            }
        }

        window.addEventListener('resize', resizeCanvas);

        // --- Core Game Engine ---
        function initGameEngine(type) {
            if (!overlay) overlay = document.getElementById('html-overlay');

            if (overlay) {
                overlay.innerHTML = "";
                overlay.style.pointerEvents = "none";
            }

            if (type === 'chess') startChess();
            else if (type.includes('racing') || type === 'police-chase') startRacing(type);

            else if (type === 'carrom') {
                startCarrom();
            }
        }

        // --- Chess Play Store Edition ---
        let chessGame = null;
        let board = null;
        let playerTimer = 600; // 10 minutes
        let opponentTimer = 600;
        let timerInterval = null;
        let myRole = 'white';
        let currentRoomId = null;
        let squareSelected = null;
        let aiWorker = null;

        function initAIWorker() {
            if (aiWorker) aiWorker.terminate();
            aiWorker = new Worker('chess-ai-worker.js');
            aiWorker.onmessage = function (e) {
                const { bestMove } = e.data;
                executeAIMove(bestMove);
            };
        }

        // High-Fidelity Studio-Quality Audio Assets
        const sounds = {
            move: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-self.mp3'),
            capture: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/capture.mp3'),
            check: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-check.mp3'),
            click: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/premove.mp3'),
            notify: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/notify.mp3'),
            castle: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/castle.mp3'),
            promote: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/promote.mp3'),
            gameover: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/game-end.mp3')
        };

        function playSound(type) {
            try {
                const s = sounds[type];
                if (s) {
                    // Realistic Variation: slight pitch and volume jitter
                    const jitter = (Math.random() * 0.1) + 0.95; // 0.95 to 1.05
                    const volJitter = (Math.random() * 0.05) + 0.95; // 0.95 to 1.0

                    s.playbackRate = jitter;
                    s.volume = volJitter;
                    s.currentTime = 0;
                    s.play().catch(e => {
                        if (e.name !== 'NotAllowedError') console.warn("Audio play error:", e);
                    });
                }
            } catch (e) { }
        }

        function startChess() {
            overlay.style.pointerEvents = "auto";
            document.querySelector('.back-btn').style.display = 'none';

            overlay.innerHTML = ` 
                <div class="chess-container chess-wood-theme"> 
                    
                    <!-- Side Controls (As per image) -->
                    <div class="side-controls">
                        <button class="round-btn" onclick="backToHub()" title="Back to Hub">
                            <span>&#x21B2;</span>
                        </button>
                        <button class="round-btn" onclick="resetSession()" title="Rematch">
                            <span>&#x21BB;</span>
                        </button>
                        <button class="round-btn" onclick="undoMove()" title="Undo Move">
                            <span>&#x21B6;</span>
                        </button>
                        <button class="round-btn" onclick="openChessSettings()" title="Settings">
                            <span>&#x2699;</span>
                        </button>
                    </div>

                    <div class="chess-main-view" style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 10px 0;" > 
                        <div class="chess-info" style="background: rgba(0,0,0,0.7); border: 2px solid #facc15; width: var(--board-size); height: 50px; padding: 0 15px; border-radius: 12px 12px 0 0;" > 
                            <div style="display: flex; align-items: center; gap: 15px;" > 
                                <div style="width: 36px; height: 36px; border: 2px solid #ef4444; border-radius: 6px; overflow: hidden; background: #1e293b;">
                                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=chess_master" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <div style="display: flex; flex-direction: column;">
                                    <div id="opp-name" style="font-size: 0.8rem; color: #facc15; font-weight: 800; opacity: 0.9;" >OPPONENT (PRO)</div> 
                                    <div id="opp-captured" class="captured-pieces" style="font-size: 0.8rem; margin-top: -2px;" ></div> 
                                </div>
                            </div> 
                            <div id="opp-timer" class="timer" style="font-weight: 900; font-size: 1.4rem; color: #facc15;" >10:00</div> 
                        </div> 
                        
                        <div id="myBoard"></div> 
                        
                        <div class="chess-info" style="background: rgba(0,0,0,0.7); border: 2px solid #facc15; width: var(--board-size); height: 50px; padding: 0 15px; border-radius: 0 0 12px 12px;" > 
                            <div style="display: flex; align-items: center; gap: 15px;" > 
                                <div style="width: 36px; height: 36px; border: 2px solid #22c55e; border-radius: 6px; overflow: hidden; background: #1e293b;">
                                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=player_me" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <div style="display: flex; flex-direction: column;">
                                    <div id="player-label" style="font-size: 0.8rem; color: #facc15; font-weight: 800; opacity: 0.9;" >YOU (WHITE)</div> 
                                    <div id="my-captured" class="captured-pieces" style="font-size: 0.8rem; margin-top: -2px;" ></div> 
                                </div>
                            </div> 
                            <div id="my-timer" class="timer" style="font-weight: 900; font-size: 1.4rem; color: #facc15;" >10:00</div> 
                        </div> 

                        <div id="game-status" class="status-badge" style="background: #5d4037; border: 1px solid #facc15; color: #facc15; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;" >Waiting...</div> 
                    </div> 

                    <div class="move-history-panel" style="display: flex; flex-direction: column; gap: 10px; flex: 1; max-width: 250px; margin-right: 20px;" > 
                        <h3 style="margin: 0; font-size: 1rem; opacity: 0.6; color: white; text-align: center;" >MOVE HISTORY</h3> 
                        <div id="move-list" class="move-history" style="background: rgba(0,0,0,0.6); border: 1px solid #5d4037; width: 100%; height: var(--board-size);" ></div> 
                    </div> 

                    <!-- Settings Modal -->
                    <div id="chess-settings-modal" class="settings-overlay">
                        <div class="settings-modal">
                            <div class="settings-header">
                                <h2 style="margin:0; font-size: 1.2rem; color: #facc15;">CHESS SETTINGS</h2>
                                <button onclick="closeChessSettings()" style="background:none; border:none; color:white; font-size: 1.5rem; cursor:pointer;">&times;</button>
                            </div>
                            <div class="settings-row">
                                <label>Premium Wood Pieces</label>
                                <label class="switch">
                                    <input type="checkbox" id="setting-wood-pieces" checked onchange="togglePieceTheme()">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="settings-row">
                                <label>Show Legal Moves</label>
                                <label class="switch">
                                    <input type="checkbox" id="setting-hints" checked onchange="removeHighlights()">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="settings-row">
                                <label>Board Coordinates</label>
                                <label class="switch">
                                    <input type="checkbox" id="setting-coords" onchange="toggleCoords()">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <button class="game-btn" onclick="closeChessSettings()" style="width:100%; padding: 10px; margin-top: 10px; background: #5d4037; color: #facc15; border: 1px solid #facc15;">Save & Close</button>
                        </div>
                    </div>
                </div> `;

            // Update player label with role after HTML is set
            setTimeout(() => {
                const label = document.getElementById('player-label');
                if (label && myRole) label.innerText = `YOU (${myRole.toUpperCase()})`;
            }, 50);

            chessGame = new Chess();
            squareSelected = null;

            const config = {
                draggable: true,
                position: 'start',
                orientation: myRole === 'black' ? 'black' : 'white',
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
                moveSpeed: 'fast',
                snapSpeed: 50,
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: onSnapEnd,
                onMouseoutSquare: onMouseoutSquare,
                onMouseoverSquare: onMouseoverSquare
            };

            board = Chessboard('myBoard', config);

            // Manual square click listener
            $('#myBoard').off('click').on('click', 'div[class*="square-"]', function () {
                const square = $(this).attr('data-square');
                onSquareClick(square);
            });
            updateStatus();

            if (isMultiplayer && socket && socket.connected) {
                document.getElementById('matchmaking-overlay').style.display = 'flex';
            }

            else {
                initAIWorker();
                startTimers();
            }

            resizeCanvas(); // Set initial scale
        }

        function onDragStart(source, piece, position, orientation) {
            if (chessGame.game_over()) return false;

            // Turn enforcement & Color ownership
            if (isMultiplayer) {
                if ((myRole === 'white' && piece.search(/^b/) !== -1) || (myRole === 'black' && piece.search(/^w/) !== -1)) return false;

                if (chessGame.turn() !== (myRole === 'white' ? 'w' : 'b')) return false;
            }

            else {
                if ((chessGame.turn() === 'w' && piece.search(/^b/) !== -1) || (chessGame.turn() === 'b' && piece.search(/^w/) !== -1)) return false;
            }

            playSound('click'); // Play sound on pickup
            // Highlight possible moves
            showLegalMoves(source);
            return true;
        }

        function showLegalMoves(square) {
            const showHints = document.getElementById('setting-hints').checked;
            if (!showHints) return;

            const moves = chessGame.moves({
                square: square,
                verbose: true
            });

            if (moves.length === 0) return;

            // Highlight source
            $(`#myBoard .square-${square}`).addClass('highlight-white');

            // Highlight targets
            moves.forEach(m => {
                const $sq = $(`#myBoard .square-${m.to}`);
                if (m.captured) $sq.addClass('highlight-hint-capture');
                else $sq.addClass('highlight-hint');
            });
        }

        function removeHighlights() {
            $('#myBoard div[class*="square-"]').removeClass('highlight-white highlight-black highlight-hint highlight-hint-capture');
        }

        function onSquareClick(square) {

            // Click-to-move support
            if (squareSelected) {
                const move = chessGame.move({
                    from: squareSelected,
                    to: square,
                    promotion: 'q'
                });

                if (move !== null) {
                    board.position(chessGame.fen());
                    updateStatus();
                    if (isMultiplayer) sendMoveToServer(move);
                    else aiMove();
                    squareSelected = null;
                    removeHighlights();
                    return;
                }
            }

            const piece = chessGame.get(square);

            if (piece && piece.color === chessGame.turn()) {
                if (isMultiplayer && piece.color !== (myRole === 'white' ? 'w' : 'b')) return;
                squareSelected = square;
                playSound('click');
                removeHighlights();
                showLegalMoves(square);
            }

            else {
                squareSelected = null;
                removeHighlights();
            }
        }

        function onDrop(source, target) {
            removeHighlights();

            const move = chessGame.move({
                from: source,
                to: target,
                promotion: 'q'
            });

            if (move === null) return 'snapback';

            if (move.captured) playSound('capture');
            else if (move.flags.includes('k') || move.flags.includes('q')) playSound('castle');
            else playSound('move');

            if (chessGame.in_check()) playSound('check');

            board.position(chessGame.fen());
            squareSelected = null;
            updateStatus();

            if (isMultiplayer) {
                sendMoveToServer(move);
            }

            else {
                // UPDATE FASTER: Reduced delay for AI from 1000ms to 300ms
                aiMove();
            }
        }

        function aiMove() {
            if (!chessGame || chessGame.game_over()) return;
            if (!aiWorker) initAIWorker();

            // Notify UI that AI is thinking
            const statusEl = document.getElementById('game-status');
            if (statusEl) statusEl.innerText = "Computer is thinking...";

            aiWorker.postMessage({ fen: chessGame.fen() });
        }

        function executeAIMove(bestMove) {
            if (!chessGame || !bestMove) return;

            const moveResult = chessGame.move(bestMove);
            if (moveResult) {
                if (moveResult.captured) playSound('capture');
                else playSound('move');
                if (chessGame.in_check()) playSound('check');

                // Smooth Animation: use board.move followed by position sync
                const moveString = `${moveResult.from}-${moveResult.to}`;
                board.move(moveString);

                // Final position sync after animation (approx 200ms)
                setTimeout(() => {
                    board.position(chessGame.fen(), false);
                    updateStatus();
                }, 250);
            }
        }

        // Minimax AI logic moved to chess-ai-worker.js

        function onSnapEnd() {
            board.position(chessGame.fen());
        }

        function onMouseoverSquare(square, piece) {
            // Highlight possible moves
            showLegalMoves(square);
        }

        function onMouseoutSquare(square, piece) {
            removeHighlights();
        }

        function sendMoveToServer(move) {
            if (isMultiplayer && socket && currentRoomId) {
                socket.emit('chess-move', {

                    roomId: currentRoomId,
                    move: move,
                    fen: chessGame.fen(),
                    timeData: {
                        myTime: playerTimer, oppTime: opponentTimer
                    }
                });
            }
        }

        function receiveMoveFromServer(data) {
            if (!isMultiplayer) return;
            chessGame.move(data.move);
            board.position(chessGame.fen());
            opponentTimer = data.timeData.myTime;
            playerTimer = data.timeData.oppTime;
            updateStatus();
        }

        function updateStatus() {
            let status = '';
            let moveColor = chessGame.turn() === 'b' ? 'Black' : 'White';

            if (chessGame.in_checkmate()) {
                status = `Checkmate ! ${moveColor} loses.`;
                showGameOver('Checkmate!', `${moveColor} is defeated.`);
            }

            else if (chessGame.in_draw()) {
                status = 'Draw!';
                showGameOver('Draw!', 'The game ended in a draw.');
            }

            else {
                status = `${moveColor}'s Turn`;
                if (chessGame.in_check()) status += ` (CHECK)`;
            }

            const statusEl = document.getElementById('game-status');
            if (statusEl) statusEl.innerText = status;

            updateTimerDisplay();
            updateHistory();
            updateCaptured();
        }

        function updateHistory() {
            const history = chessGame.history({
                verbose: true
            });
            const list = document.getElementById('move-list');
            if (!list) return;
            list.innerHTML = '';

            for (let i = 0; i < history.length; i += 2) {
                const moveNum = Math.floor(i / 2) + 1;
                const whiteMove = history[i].san;
                const blackMove = history[i + 1] ? history[i + 1].san : '';

                const row = document.createElement('div');
                row.className = 'move-row';

                row.innerHTML = `<span>${moveNum}.</span> <b>${whiteMove}</b> <b>${blackMove}</b>`;
                list.appendChild(row);
            }

            list.scrollTop = list.scrollHeight;
        }

        function updateCaptured() {
            const pieces = {
                p: '‚ôü', n: '‚ôû', b: '‚ôù', r: '‚ôú', q: '‚ôõ', k: '‚ôö',
                P: '‚ôô', N: '‚ôò', B: '‚ôó', R: '‚ôñ', Q: '‚ôï', K: '‚ôî'
            };

            const boardData = chessGame.board();
            const currentPieces = { w: [], b: [] };

            boardData.forEach(row => row.forEach(sq => {
                if (sq) currentPieces[sq.color].push(sq.type.toUpperCase());
            }));

            const standardPieces = ['P', 'P', 'P', 'P', 'P', 'P', 'P', 'P', 'N', 'N', 'B', 'B', 'R', 'R', 'Q'];

            const getCaptured = (color) => {
                let captured = [...standardPieces];
                currentPieces[color].forEach(p => {
                    const idx = captured.indexOf(p);
                    if (idx !== -1) captured.splice(idx, 1);
                });
                return captured.map(p => color === 'w' ? pieces[p] : pieces[p.toLowerCase()]).join('');
            };

            const oppCaptured = document.getElementById('opp-captured');
            const myCaptured = document.getElementById('my-captured');
            if (oppCaptured) oppCaptured.innerText = getCaptured(myRole === 'white' ? 'b' : 'w');
            if (myCaptured) myCaptured.innerText = getCaptured(myRole === 'white' ? 'w' : 'b');
        }

        function undoMove() {
            if (isMultiplayer) {
                alert("Undo is only available in Single Player mode.");
                return;
            }

            // Undo twice: AI's move and then players' move
            chessGame.undo();
            chessGame.undo();

            board.position(chessGame.fen());
            updateStatus();
        }

        function openChessSettings() {
            const modal = document.getElementById('chess-settings-modal');
            if (modal) modal.style.display = 'flex';
        }

        function closeChessSettings() {
            const modal = document.getElementById('chess-settings-modal');
            if (modal) modal.style.display = 'none';
        }

        function togglePieceTheme() {
            const isWood = document.getElementById('setting-wood-pieces').checked;
            const container = document.querySelector('.chess-container');
            if (isWood) container.classList.add('chess-wood-theme');
            else container.classList.remove('chess-wood-theme');
        }

        function toggleCoords() {
            const showCoords = document.getElementById('setting-coords').checked;
            if (board) {
                board.destroy();
                const config = {
                    draggable: true,
                    position: chessGame.fen(),
                    orientation: myRole === 'black' ? 'black' : 'white',
                    showNotation: showCoords,
                    pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
                    onDragStart: onDragStart,
                    onDrop: onDrop,
                    onSnapEnd: onSnapEnd,
                    onMouseoutSquare: onMouseoutSquare,
                    onMouseoverSquare: onMouseoverSquare
                };
                board = Chessboard('myBoard', config);
            }
        }

        function startTimers() {
            stopTimers();

            timerInterval = setInterval(() => {
                if (chessGame.game_over()) return;

                if (chessGame.turn() === (myRole === 'white' ? 'w' : 'b')) {
                    playerTimer--;

                    if (playerTimer <= 0) {
                        showGameOver('Time Out!', 'Defeat by clock.');

                        if (isMultiplayer) socket.emit('chess-game-over', {
                            roomId: currentRoomId, result: 'timeout-loss'
                        });
                    }
                }

                else if (isMultiplayer) {
                    opponentTimer--;
                }

                else {
                    opponentTimer--; // In offline, both go down based on turn
                }

                updateTimerDisplay();
            }

                , 1000);
        }

        function stopTimers() {
            if (timerInterval) clearInterval(timerInterval);
        }

        function formatTime(s) {
            const min = Math.floor(s / 60);
            const sec = s % 60;
            return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            const myT = document.getElementById('my-timer');
            const oppT = document.getElementById('opp-timer');
            if (myT) myT.innerText = formatTime(playerTimer);
            if (oppT) oppT.innerText = formatTime(opponentTimer);
        }

        function showGameOver(title, desc) {
            clearInterval(timerInterval);
            const overlay = document.getElementById('game-status-msg');

            if (overlay) {
                overlay.style.display = 'block';
                document.getElementById('status-title').innerText = title;
                document.getElementById('status-desc').innerText = desc;
            }
        }

        // Multiplayer Hook
        function setupMultiplayerSocket() {
            if (!socket) return;

            // Remove existing listeners to prevent duplicates
            socket.off('role-assignment');
            socket.off('room-update');
            socket.off('chess-move');
            socket.off('chess-game-over');
            socket.off('player-disconnected');
            socket.off('racing-update');
            socket.off('carrom-move');

            socket.on('role-assignment', (data) => {
                myRole = data.role;
                if (board) board.orientation(myRole);
                const label = document.getElementById('player-label');
                if (label) label.innerText = `YOU (${myRole.toUpperCase()})`;
            });

            socket.on('room-update', (data) => {
                if (data.roomId) currentRoomId = data.roomId;

                if (data.players.length >= 2) {
                    document.getElementById('matchmaking-overlay').style.display = 'none';
                    const opp = data.players.find(p => p.id !== socket.id);
                    document.getElementById('opp-name').innerText = opp.name.toUpperCase();
                    startTimers();
                }
            });

            socket.on('chess-move', (data) => {
                receiveMoveFromServer(data);
            });

            socket.on('chess-game-over', (result) => {
                if (result === 'timeout-loss') {
                    showGameOver('Victory!', 'Opponent timed out.');
                }
            });

            socket.on('player-disconnected', (data) => {
                showGameOver('Opponent Left', `${data.name} disconnected.`);
            });

            // Racing Multiplayer Sync
            socket.on('racing-update', (data) => {
                if (window.RacingGame.instance && window.RacingGame.instance.running) {
                    window.RacingGame.instance.handleOpponentUpdate(data);
                }
            });

            // Carrom Multiplayer Sync
            socket.on('carrom-move', (data) => {
                if (carromEngine && carromEngine.active) {
                    carromEngine.handleMoveFromServer(data);
                }
            });
        }

        function resetSession() {
            playerTimer = 600;
            opponentTimer = 600;
            startChess();
        }

        // --- Racing Module ---
        function startRacing(type) {
            let overlay = document.getElementById('html-overlay');

            if (!overlay) {
                // Fallback if overlay is missing
                overlay = document.createElement('div');
                overlay.id = 'html-overlay';
                overlay.style.position = 'absolute';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100%';
                overlay.style.height = '100%';
                overlay.style.pointerEvents = 'none';
                overlay.style.zIndex = '50';
                document.body.appendChild(overlay);
            }

            overlay.innerHTML = "";
            overlay.style.pointerEvents = "auto";

            // Map types to modes
            let mode = 'normal';
            if (type === 'police-chase') mode = 'police';

            // Hide mobile controls div initially, let the game engine handle its own UI or reuse this one
            // My Racing Game implementation creates its own UI elements, so let's hide the default one
            document.getElementById('mobile-controls').style.display = 'none';

            // Start the game
            RacingGame.init(mode);

            // Handle cleanup when leaving
            // backToHub already calls RacingGame.instance.stop() if I add it there

            // Override Game Loop here? No, RacingGame handles it.
            // We just need to make sure 'backToHub' stops it.
        }

        // --- Carrom Module ---
        // --- Professional Carrom Module ---
        // --- Carrom Module (Optimized) ---
        const carromEngine = new CarromEngine();

        function startCarrom() {
            carromEngine.stop(); // Stop potential previous instance

            // Create a dedicated UI layer for Carrom
            let oldUi = document.getElementById('carrom-ui-layer');
            if (oldUi) oldUi.remove();

            const uiLayer = document.createElement('div');
            uiLayer.id = 'carrom-ui-layer';
            uiLayer.style.cssText = `
                position: fixed;
                top: 0; left: 0;
                width: 100vw; height: 100vh;
                pointer-events: none;
                z-index: 9999;
            `;

            // Add Exit Button for Carrom
            const exitBtn = document.createElement('button');
            exitBtn.innerText = 'Exit Match';
            exitBtn.style.cssText = `
                position: absolute;
                top: 15px;
                right: 15px;
                background: rgba(239, 68, 68, 0.9);
                border: 2px solid #ef4444;
                color: white;
                padding: 10px 24px;
                border-radius: 12px;
                font-weight: 800;
                cursor: pointer;
                pointer-events: auto;
                z-index: 10000;
                text-transform: uppercase;
                letter-spacing: 1px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.4);
                transition: transform 0.1s active;
            `;
            exitBtn.onclick = () => {
                backToHub();
                stopCarrom();
            };
            uiLayer.appendChild(exitBtn);

            document.body.appendChild(uiLayer);
            document.querySelector('.back-btn').style.display = 'none';
            carromEngine.start(canvas, uiLayer, ctx);
        }

        function stopCarrom() {
            carromEngine.stop();
            const ui = document.getElementById('carrom-ui-layer');
            if (ui) ui.remove();
            document.querySelector('.back-btn').style.display = 'block';
        }

        function showGameOver(title, desc, showRestart = false) {
            document.getElementById('status-title').innerText = title;
            document.getElementById('status-desc').innerText = desc;
            const overlay = document.getElementById('game-status-msg');
            overlay.style.display = 'block';

            // Add restart button if needed
            let restartBtn = document.getElementById('restart-btn');

            if (showRestart) {
                if (!restartBtn) {
                    restartBtn = document.createElement('button');
                    restartBtn.id = 'restart-btn';
                    restartBtn.className = 'game-btn';
                    restartBtn.style.position = 'static';
                    restartBtn.style.marginTop = '10px';
                    restartBtn.innerText = 'Restart Game';
                    restartBtn.onclick = restartGame;
                    overlay.appendChild(restartBtn);
                }

                restartBtn.style.display = 'inline-block';
            }

            else if (restartBtn) {
                restartBtn.style.display = 'none';
            }
        }

        function restartGame() {
            document.getElementById('game-status-msg').style.display = 'none';

            if (currentGame === 'carrom') {
                // Clear the board and re-init
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                startCarrom();
            }
        }

        // --- Initial Fallback Check ---
        toggleMultiplayer();
    </script>
</body>

</html>